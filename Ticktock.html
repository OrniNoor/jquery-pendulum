
<!-- saved from url=(0036)http://daneden.me/labs/pendulum.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Tick, tock.</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
  
    <script src="jquery.pendulum.js"></script>

    <style type="text/css" id="animationDefinition">
	@-webkit-keyframes swinging {
		0% {				-webkit-transform: rotate(0deg);			}
		100% {				-webkit-transform: rotate(0deg);			}
	}
	body {			text-align: center;			background: #444;		}
	.pendulum-bob {	
		margin: 0 auto;
		
		background: #ccc;
		color: #333;
		-webkit-border-radius: 1000px;
		margin: 0 px;
		font-weight: bold;
		-webkit-box-shadow: 0 0 20px rgba(0,0,0,.3);		}
	.container {
		padding-top: 100px;
		background: #ddd;
        display:inline-block;
	}
	.swinger {
        -webkit-transform-origin: top;
		-webkit-animation: swinging 1s 1 ease-in-out;
	}
	</style>
</head>
<body>
	<script>


// search the CSSOM for a specific rule
function findCssRule(rule) {
        // gather all stylesheets into an array
        var ss = document.styleSheets;
        
        // loop through the stylesheets
        for (var i = 0; i < ss.length; ++i) {
            
            // loop through all the rules
            for (var j = 0; j < ss[i].cssRules.length; ++j) {
                // find the -webkit-keyframe rule whose name matches our passed over parameter and return that rule
                if (ss[i].cssRules[j].selectorText == rule)
                    return ss[i].cssRules[j];
            }
        }
        // rule not found
        return null;
}

// search the CSSOM for a specific -webkit-keyframe rule
function findKeyframesRule(rule) {
        // gather all stylesheets into an array
        var ss = document.styleSheets;
        
        // loop through the stylesheets
        for (var i = 0; i < ss.length; ++i) {
            
            // loop through all the rules
            for (var j = 0; j < ss[i].cssRules.length; ++j) {
                
                // find the -webkit-keyframe rule whose name matches our passed over parameter and return that rule
                if (ss[i].cssRules[j].type == window.CSSRule.WEBKIT_KEYFRAMES_RULE && ss[i].cssRules[j].name == rule)
                    return ss[i].cssRules[j];
            }
        }
        // rule not found
        return null;
}

var swingDurationRule = findCssRule(".swinger");

// remove old keyframes and add new ones
function change(anim, sAngle)
    {
        // find our -webkit-keyframe rule
        var keyframes = findKeyframesRule(anim);
        
        // remove all of the existing % rules
        for (var key in keyframes) {
            var r = keyframes[key];
            if (r instanceof WebKitCSSKeyframeRule) {
                keyframes.deleteRule(r.keyText);
            }
        }
        
        
        var startingAngle = sAngle;
        var damping = 1.9;
        var period=0.9; // in seconds, for a complete swing and swing back
        var overallDuration = 11.1; // in seconds

        swingDurationRule.style.webkitAnimationDuration = overallDuration + "s"; // this may be overwritten by individual elements' swing rate, using modifySwingByPendulumLength()

        var swingTime = period/2;
        for (var time=0; time <= overallDuration; time=time+swingTime) {
        	var pc = time* (100/overallDuration);
        	var angle = getAngle(startingAngle, period, time, damping);
        	console.log("percent is " + pc + "% and time is " + time + ".  The new angle is " + angle);
            keyframes.insertRule( pc + "% { -webkit-transform: rotate("+angle+"deg); }");
            //keyframes.insertRule( pc + "% { -webkit-transform: rotate3s(1 1 3 "+angle+"deg); }");
        }
        // create rules
        //keyframes.insertRule("0% { -webkit-transform: rotate(-"+rand+"deg); }");
        keyframes.insertRule("100% { -webkit-transform: rotate(0deg); }"); // a bit hacky but it helps remove leaps at the end


        // assign a modifier for duration, so larger pendulums swing slower
        $('.swinger').each( function() {
            modifySwingByPendulumLength( $(this) );
        });


        // assign the animation to our element (which will cause the animation to run)
        $('.swinger').each( function() { this.style.webkitAnimationName = anim } );

        $(".swinger").each( function() { $(this).css("webkit-transform", "rotate(0deg)") } );
    }

// begin the new animation process
function startSwinging( angle , elements) {
    // remove the old animation from our object
    elements.each( function() { this.style.webkitAnimationName = "none" } );
    // correct for swings that are too large
    if (angle < -90) {angle = -90;}
    if (angle > 90) {angle = 90;}

    // call the change method, which will update the keyframe animation
    setTimeout( function(){
        change("swinging", angle);
    }, 0);
}



function getAngle(Θ, period, time, decayConstant) {
	// physics note - decayConstant should be really big for small damping.  Period is for a whole cycle.
	var angle = Θ * Math.exp(-time/decayConstant) * Math.cos((2* Math.PI * time) / period);
	return angle
}

function modifySwingByPendulumLength(pendulum) {
    // we're nominally shooting for 100px to be the "standard" pendulum (but set it to any sensible value that's required to tune it), so deviation from that length causes a modification in the overall time that the animation will take.

    var length = pendulum.outerHeight();
    var baselineLength = 100;
    var baselineDuration = parseFloat(swingDurationRule.style.webkitAnimationDuration.substr(0, swingDurationRule.style.webkitAnimationDuration.length-1));
    var ratio = Math.sqrt(pendulum.outerHeight()) / Math.sqrt(baselineLength);
    pendulum.css("webkitAnimationDuration", baselineDuration * ratio + "s");
}






// make dragging interaction
$(document).ready(function() {
    $("#a").draggable(
        { axis: "x"},
        { distance: 3 },
        { drag: function(event, ui) {
            console.log(event);
            console.log(ui);
            $("#startAngle").val( (ui.originalPosition.left - ui.position.left) /5  );
        }},
        { stop: function(event, ui) {
            console.log("stop");
            console.log(event);
            console.log(ui);   
            startSwinging( $("#startAngle").val() , $('.swinger'));  // apply to all .swinger objects 
        }}

    );
  });



// set up buttons in the form
$(function() {
    $('#start').bind('click',function(e) {
        e.preventDefault();
        startSwinging( $("#startAngle").val() , $('.swinger') );  // apply to all .swinger class objects       
    });

    $("#set").bind('click', function(e) {
        e.preventDefault();

        // remove the old animation from our object
        $('.swinger').each( function() { this.style.webkitAnimationName = "none" } );
        swingDurationRule.style.webkitAnimationDuration = "0s";
        $(".swinger").each( function() { $(this).css("webkit-transform", "rotate(" + $("#startAngle").val() +"deg)") } )
    })        
});



	</script>

<div id="a">

    <div class="container swinger" id="c">
        <div class="pendulum-bob">
            tick, tock.
        </div>
    </div>
    <br/>
    <div class="container swinger" id="d" >
        <div class="pendulum-bob swinger">
            tick, tock<br/>tick tock.
        </div>
        <div class="pendulum-bob swinger">
            tick, tock<br/>tick tock.
        </div>
    </div>
    <div class="container swinger" id="e" >
        <div class="pendulum-bob">
            tick, tock<br/>tick tock.<br/>tick tock.<br/>tick tock.<br/>tick tock.<br/>tick tock.<br/>tick tock.
        </div>
    </div>
    <div class="swinger" id="f" >
        <div>
            tick, tock<br/>tick tock.<br/>tick tock.<br/>tick tock.<br/>tick tock.
        </div>
    </div>

</div>

<div id="update-box">
    <input type="text" value="45" id="startAngle" />
    <button id="set">set start angle</button>
    <button id="start">Run Another Animation</button>
</div>



<div id="pluginTester" style="background-color:red; width:80">
    Test
</div>

<script>

    $("#pluginTester").pendulum({rodLength:100});

</script>








</body></html>